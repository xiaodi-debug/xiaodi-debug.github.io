<!DOCTYPE html><html lang="zh-CN" dir="ltr"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收 | 大神之路</title>
    <meta name="description" content="多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。">
    <meta name="generator" content="VitePress v1.6.4">
    <link rel="preload stylesheet" href="/assets/style.BQntlC0i.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.BztCUr2G.js"></script>
    <link rel="modulepreload" href="/assets/chunks/theme.DVn9EiGk.js">
    <link rel="modulepreload" href="/assets/chunks/framework.D-E96EZ1.js">
    <link rel="modulepreload" href="/assets/posts_2025_nestjs-typeorm-db-per-tenant-practical.md.DeZoFMpW.lean.js">
    <link rel="icon" href="/images/logo/logo.svg">
    <meta name="referrer" content="no-referrer">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://liuxiaodi.icu/rss.xml">
    <link crossorigin="" rel="preconnect" href="https://s1.hdslb.com">
    <link crossorigin="" rel="preconnect" href="https://mirrors.sustech.edu.cn">
    <link crossorigin="anonymous" rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css">
    <link crossorigin="anonymous" rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.css">
    <link crossorigin="anonymous" rel="stylesheet" href="https://cdn2.codesign.qq.com/icons/g5ZpEgx3z4VO6j2/latest/iconfont.css">
    <link rel="preconnect" href="https://use.sevencdn.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link crossorigin="anonymous" href="https://use.sevencdn.com/css2?family=Fira+Code:wght@300..700&amp;display=swap" rel="stylesheet">
    <link href="https://X5EBEZB53I-dsn.algolia.net" rel="preconnect" crossorigin="">
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js" defer=""></script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"dark",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <link rel="canonical" href="https://liuxiaodi.icu/posts/2025/nestjs-typeorm-db-per-tenant-practical">
    <link rel="manifest" href="/manifest.webmanifest">
    <script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script>
  </head>
  <body><!--teleport start anchor--><div class="background patterns light" data-v-ccc3ddf6=""><!----></div><!--teleport anchor--><!--teleport start anchor--><div class="loading" data-v-9e9a6c94=""><div class="spinner" data-v-9e9a6c94=""></div><span class="text" data-v-9e9a6c94="">加载中…</span></div><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><div class="mobile-menu" style="display:none;" data-v-e151ee7e=""><div class="menu-mask" data-v-e151ee7e=""></div><div class="menu-content s-card" style="display:none;" data-v-e151ee7e=""><div class="close-control" data-v-e151ee7e=""><i class="iconfont icon-close" data-v-e151ee7e=""></i></div><div class="menu-list" data-v-e151ee7e=""><!--[--><div class="menu-item" data-v-e151ee7e=""><span class="link-title" data-v-e151ee7e="">文库</span><div class="link-child" data-v-e151ee7e=""><!--[--><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-article" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">文章列表</span></div><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-folder" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">全部分类</span></div><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-hashtag" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">全部标签</span></div><!--]--></div></div><div class="menu-item" data-v-e151ee7e=""><span class="link-title" data-v-e151ee7e="">专栏</span><div class="link-child" data-v-e151ee7e=""><!--[--><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-technical" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">技术分享</span></div><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-code" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">我的项目</span></div><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-tools" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">效率工具</span></div><!--]--></div></div><div class="menu-item" data-v-e151ee7e=""><span class="link-title" data-v-e151ee7e="">友链</span><div class="link-child" data-v-e151ee7e=""><!--[--><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-fish" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">友链鱼塘</span></div><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-people" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">友情链接</span></div><!--]--></div></div><div class="menu-item" data-v-e151ee7e=""><span class="link-title" data-v-e151ee7e="">我的</span><div class="link-child" data-v-e151ee7e=""><!--[--><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-chat" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">畅所欲言</span></div><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-reward" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">致谢名单</span></div><div class="link-child-btn" data-v-e151ee7e=""><i class="iconfont icon-contacts" data-v-e151ee7e=""></i><span class="name" data-v-e151ee7e="">关于本站</span></div><!--]--></div></div><!--]--></div><hr data-v-e151ee7e=""><div class="tags-list menu-item" data-v-e151ee7e=""><span class="link-title" data-v-e151ee7e=""> 标签</span><div class="link-child" data-v-e151ee7e=""><!--[--><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">Node.js</span><sup class="num" data-v-e151ee7e="">4</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">NestJS</span><sup class="num" data-v-e151ee7e="">5</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">TypeORM</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">MySQL</span><sup class="num" data-v-e151ee7e="">4</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">PostgreSQL</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">连接池</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">多租户</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">架构</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">实战</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">Redis</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">缓存</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">性能优化</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">学习笔记</span><sup class="num" data-v-e151ee7e="">4</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">Docker</span><sup class="num" data-v-e151ee7e="">3</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">Docker Compose</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">Nginx</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">部署</span><sup class="num" data-v-e151ee7e="">2</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">DevOps</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">NAS</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">自建服务</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">踩坑记录</span><sup class="num" data-v-e151ee7e="">4</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">数据库设计</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">REST API</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">Vue3</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">组合式API</span><sup class="num" data-v-e151ee7e="">1</sup></div><div class="link-child-btn" data-v-e151ee7e=""><span class="name" data-v-e151ee7e="">实战笔记</span><sup class="num" data-v-e151ee7e="">1</sup></div><!--]--></div></div></div></div><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><div class="left-menu" data-v-bb73145d=""><div class="settings" data-v-bb73145d="" data-v-a3500e44=""><div class="set-btn s-card" data-v-a3500e44=""><i class="iconfont icon-style" data-v-a3500e44=""></i><span class="set-text" data-v-a3500e44="">个性化配置</span></div><!--teleport start--><!--teleport end--></div><div class="player" data-v-bb73145d="" data-v-f7afadec=""><div class="player-content" data-v-f7afadec=""></div></div></div><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport start--><!--teleport end--><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor-->
    <div id="app"><!--[--><!--teleport start--><!--teleport end--><!--teleport start--><!--teleport end--><!--teleport start--><!--teleport end--><header class="main-header" data-v-bb73145d="" data-v-e39e8039=""><nav class="main-nav down top" data-v-e39e8039=""><div class="nav-all" data-v-e39e8039=""><div class="left-nav" data-v-e39e8039=""><div class="more-menu nav-btn" title="更多内容" data-v-e39e8039=""><i class="iconfont icon-menu" data-v-e39e8039=""></i><div class="more-card s-card" data-v-e39e8039=""><!--[--><div class="more-item" data-v-e39e8039=""><span class="more-name" data-v-e39e8039="">博客</span><div class="more-list" data-v-e39e8039=""><!--[--><a href="/" class="more-link" target="_blank" data-v-e39e8039=""><img class="link-icon" src="/images/logo/logo.webp" alt="大神之路" data-v-e39e8039=""><span class="link-name" data-v-e39e8039="">大神之路</span></a><a href="https://github.com/xiaodi-debug" class="more-link" target="_blank" data-v-e39e8039=""><img class="link-icon" src="/images/logo/logo.webp" alt="GitHub" data-v-e39e8039=""><span class="link-name" data-v-e39e8039="">GitHub</span></a><!--]--></div></div><!--]--></div></div><div class="site-name" data-v-e39e8039="">大神之路</div></div><div class="nav-center" data-v-e39e8039=""><div class="site-menu" data-v-e39e8039=""><!--[--><div class="menu-item" data-v-e39e8039=""><span class="link-btn" data-v-e39e8039="">文库</span><div class="link-child" data-v-e39e8039=""><!--[--><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-article" data-v-e39e8039=""></i> 文章列表</span><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-folder" data-v-e39e8039=""></i> 全部分类</span><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-hashtag" data-v-e39e8039=""></i> 全部标签</span><!--]--></div></div><div class="menu-item" data-v-e39e8039=""><span class="link-btn" data-v-e39e8039="">专栏</span><div class="link-child" data-v-e39e8039=""><!--[--><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-technical" data-v-e39e8039=""></i> 技术分享</span><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-code" data-v-e39e8039=""></i> 我的项目</span><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-tools" data-v-e39e8039=""></i> 效率工具</span><!--]--></div></div><div class="menu-item" data-v-e39e8039=""><span class="link-btn" data-v-e39e8039="">友链</span><div class="link-child" data-v-e39e8039=""><!--[--><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-fish" data-v-e39e8039=""></i> 友链鱼塘</span><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-people" data-v-e39e8039=""></i> 友情链接</span><!--]--></div></div><div class="menu-item" data-v-e39e8039=""><span class="link-btn" data-v-e39e8039="">我的</span><div class="link-child" data-v-e39e8039=""><!--[--><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-chat" data-v-e39e8039=""></i> 畅所欲言</span><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-reward" data-v-e39e8039=""></i> 致谢名单</span><span class="link-child-btn" data-v-e39e8039=""><i class="iconfont icon-contacts" data-v-e39e8039=""></i> 关于本站</span><!--]--></div></div><!--]--></div><span class="site-title" data-v-e39e8039="">NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收</span></div><div class="right-nav" data-v-e39e8039=""><a class="menu-btn nav-btn travellings" title="开往-友链接力" href="https://www.travellings.cn/go.html" target="_blank" data-v-e39e8039=""><i class="iconfont icon-subway" data-v-e39e8039=""></i></a><div class="menu-btn nav-btn" title="随机前往一篇文章" data-v-e39e8039=""><i class="iconfont icon-shuffle" data-v-e39e8039=""></i></div><!----><div id="open-control" class="menu-btn nav-btn pc" title="打开中控台" data-v-e39e8039=""><i class="iconfont icon-dashboard" data-v-e39e8039=""></i></div><div class="to-top menu-btn hidden" title="返回顶部" data-v-e39e8039=""><div class="to-top-btn" data-v-e39e8039=""><span class="num" data-v-e39e8039="">0</span><i class="iconfont icon-up" data-v-e39e8039=""></i></div></div><div class="menu-btn nav-btn mobile" title="打开菜单" data-v-e39e8039=""><i class="iconfont icon-toc" data-v-e39e8039=""></i></div></div></div></nav><!--teleport start--><!--teleport end--><!----></header><main class="mian-layout loading is-post" data-v-bb73145d=""><!----><!--[--><div class="post" data-v-bb73145d="" data-v-ed288e97=""><div class="post-meta" data-v-ed288e97=""><div class="meta" data-v-ed288e97=""><div class="categories" data-v-ed288e97=""><!--[--><a href="/pages/categories/后端" class="cat-item" data-v-ed288e97=""><i class="iconfont icon-folder" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">后端</span></a><!--]--></div><div class="tags" data-v-ed288e97=""><!--[--><a href="/pages/tags/Node.js" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">Node.js</span></a><a href="/pages/tags/NestJS" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">NestJS</span></a><a href="/pages/tags/TypeORM" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">TypeORM</span></a><a href="/pages/tags/MySQL" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">MySQL</span></a><a href="/pages/tags/PostgreSQL" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">PostgreSQL</span></a><a href="/pages/tags/多租户" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">多租户</span></a><a href="/pages/tags/连接池" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">连接池</span></a><a href="/pages/tags/架构" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">架构</span></a><a href="/pages/tags/实战" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">实战</span></a><!--]--></div></div><h1 class="title" data-v-ed288e97="">NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收</h1><div class="other-meta" data-v-ed288e97=""><span class="meta date" data-v-ed288e97=""><i class="iconfont icon-date" data-v-ed288e97=""></i> 4天前</span><span class="update meta" data-v-ed288e97=""><i class="iconfont icon-time" data-v-ed288e97=""></i> 今日内</span><span class="hot meta" data-v-ed288e97=""><i class="iconfont icon-fire" data-v-ed288e97=""></i><span id="twikoo_visitors" class="artalk-pv-count" data-v-ed288e97="">0</span></span><span class="chat meta hover" data-v-ed288e97=""><i class="iconfont icon-chat" data-v-ed288e97=""></i><span id="twikoo_comments" class="artalk-comment-count" data-v-ed288e97="">0</span></span></div></div><div class="post-content" data-v-ed288e97=""><article class="post-article s-card" data-v-ed288e97=""><!----><div class="article-gpt s-card" data-v-ed288e97="" data-v-8be9cdf0=""><div class="title" data-v-8be9cdf0=""><span class="name" data-v-8be9cdf0=""><i class="iconfont icon-robot" data-v-8be9cdf0=""></i> 文章摘要 <i class="iconfont icon-up" data-v-8be9cdf0=""></i></span><span class="logo loading" data-v-8be9cdf0=""> FakeGPT </span></div><div class="content s-card" data-v-8be9cdf0=""><span class="text" data-v-8be9cdf0="">加载中...</span><span class="point" data-v-8be9cdf0="">|</span></div><div class="meta" data-v-8be9cdf0=""><span class="tip" data-v-8be9cdf0="">此内容根据文章生成，并经过人工审核，仅用于文章内容的解释与总结</span><a href="https://eqnxweimkr5.feishu.cn/share/base/form/shrcnCXCPmxCKKJYI3RKUfefJre" class="report" target="_blank" data-v-8be9cdf0=""> 投诉 </a></div></div><div style="position:relative;" id="page-content" class="markdown-main-style" data-v-ed288e97=""><div><h2 id="目标与前提" tabindex="-1">目标与前提 <a class="header-anchor" href="#目标与前提" aria-label="Permalink to &quot;目标与前提&quot;">​</a></h2><p>目标：在 NestJS + TypeORM（v0.3+）项目中实现 <strong>DB per tenant</strong>：</p><ul><li>每个租户一个独立数据库（或独立 schema）</li><li>同一套服务处理所有租户请求</li><li>请求进来后按 <code>tenantId</code> 选择正确的数据库连接池（DataSource）</li><li>DataSource <strong>缓存复用</strong>（不能每次请求都 new）</li><li>并发场景下避免同一租户重复 <code>initialize()</code>（否则连接池会爆炸）</li><li>可选：对“长时间不活跃租户”的 DataSource 做回收</li></ul><p>本文假设你已经能跑起来一个普通 NestJS + TypeORM 项目。</p><hr><h2 id="总体架构-建议照这个分层" tabindex="-1">总体架构（建议照这个分层） <a class="header-anchor" href="#总体架构-建议照这个分层" aria-label="Permalink to &quot;总体架构（建议照这个分层）&quot;">​</a></h2><div class="language-txt vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>请求 -&gt; TenantMiddleware（解析 tenantId）</span></span>
<span class="line"><span>     -&gt; TenantRegistryService（从“租户元数据表”拿 DB 配置）</span></span>
<span class="line"><span>     -&gt; TenantDataSourceManager（按 tenantId 缓存 DataSource，单飞锁初始化）</span></span>
<span class="line"><span>     -&gt; REQUEST scope Provider（把本次请求的 tenant DataSource / EntityManager 注入）</span></span>
<span class="line"><span>     -&gt; 业务 Service（像正常 TypeORM 一样用 Repository/EntityManager）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>关键原则：</p><ul><li><strong>REQUEST scope 只负责“取哪个租户”</strong>，不要在请求级创建连接池</li><li><strong>DataSource 是跨请求复用的</strong>，应该由单例 manager 缓存管理</li></ul><hr><h2 id="step-1-租户从哪里来-建议-jwt-网关注入-子域名" tabindex="-1">Step 1：租户从哪里来？（建议：JWT / 网关注入 / 子域名） <a class="header-anchor" href="#step-1-租户从哪里来-建议-jwt-网关注入-子域名" aria-label="Permalink to &quot;Step 1：租户从哪里来？（建议：JWT / 网关注入 / 子域名）&quot;">​</a></h2><p>为了聚焦实现，这里用 <code>x-tenant-id</code> 演示。</p><p>注意：</p><ul><li>对公网服务来说，<code>x-tenant-id</code> <strong>不可信</strong>，必须由网关校验注入，或从 JWT 解析。</li><li>你真正落地时，只需要把本文的 <code>TenantMiddleware</code> 里解析 tenant 的逻辑替换掉即可。</li></ul><h3 id="tenantmiddleware" tabindex="-1">TenantMiddleware <a class="header-anchor" href="#tenantmiddleware" aria-label="Permalink to &quot;TenantMiddleware&quot;">​</a></h3><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { BadRequestException, Injectable, NestMiddleware } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/common"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { NextFunction, Request, Response } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "express"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">declare</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> module</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "express-serve-static-core"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    tenantId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Injectable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TenantMiddleware</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NestMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  use</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">_res</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NextFunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tenantId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">header</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">"x-tenant-id"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tenantId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BadRequestException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">"Missing x-tenant-id"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    req.tenantId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tenantId;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>在某个模块（比如 <code>AppModule</code>）里应用：</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { MiddlewareConsumer, Module, NestModule } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/common"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // imports/providers ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AppModule</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NestModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  configure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">consumer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MiddlewareConsumer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    consumer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TenantMiddleware).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">forRoutes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">"*"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><hr><h2 id="step-2-租户注册表-tenant-registry" tabindex="-1">Step 2：租户注册表（Tenant Registry） <a class="header-anchor" href="#step-2-租户注册表-tenant-registry" aria-label="Permalink to &quot;Step 2：租户注册表（Tenant Registry）&quot;">​</a></h2><p>你需要一个“主库”（或配置中心）存放租户的 DB 信息。</p><p>一种常见做法：</p><ul><li>固定连接一个 <code>registry_db</code></li><li>里面有一张 <code>tenants</code> 表：<code>tenant_id, db_host, db_port, db_user, db_pass, db_name, status...</code></li></ul><h3 id="定义返回结构" tabindex="-1">定义返回结构 <a class="header-anchor" href="#定义返回结构" aria-label="Permalink to &quot;定义返回结构&quot;">​</a></h3><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TenantDbConfig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  tenantId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "mysql"</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "postgres"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  username</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  password</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  database</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="tenantregistryservice-示意" tabindex="-1">TenantRegistryService（示意） <a class="header-anchor" href="#tenantregistryservice-示意" aria-label="Permalink to &quot;TenantRegistryService（示意）&quot;">​</a></h3><p>这里不强行绑定你一定要用 TypeORM 查 registry（你也可以用 Prisma、SQL、甚至配置文件）。核心是：</p><ul><li>输入 tenantId</li><li>输出该租户的 DB 连接配置</li></ul><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Injectable, NotFoundException } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/common"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Injectable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TenantRegistryService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getTenantDbConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tenantId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TenantDbConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 示例：你这里可以查 registry_db 的 tenants 表</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 这里用伪数据占位（真实项目别写死）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tenantId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "demo"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tenantId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">"mysql"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        host: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DEMO_DB_HOST</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "127.0.0.1"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        port: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DEMO_DB_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3306</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        username: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DEMO_DB_USER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "root"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        password: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DEMO_DB_PASS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "root"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        database: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DEMO_DB_NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "tenant_demo"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NotFoundException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Unknown tenant: ${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tenantId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>建议：Registry 查询结果也可以加缓存（比如 Redis），避免每次请求都查 registry。</p><hr><h2 id="step-3-tenantdatasourcemanager-核心-缓存-并发单飞锁" tabindex="-1">Step 3：TenantDataSourceManager（核心：缓存 + 并发单飞锁） <a class="header-anchor" href="#step-3-tenantdatasourcemanager-核心-缓存-并发单飞锁" aria-label="Permalink to &quot;Step 3：TenantDataSourceManager（核心：缓存 + 并发单飞锁）&quot;">​</a></h2><p>这里是 DB per tenant 的关键。</p><h3 id="你必须解决的两个问题" tabindex="-1">你必须解决的两个问题 <a class="header-anchor" href="#你必须解决的两个问题" aria-label="Permalink to &quot;你必须解决的两个问题&quot;">​</a></h3><ul><li><strong>重复初始化</strong>：同一租户并发请求进来，可能同时走到 <code>initialize()</code>。</li><li><strong>无限增长</strong>：租户非常多时，DataSource 缓存会越堆越多。</li></ul><p>下面给出一个可落地骨架：</p><ul><li><code>dataSources: Map&lt;string, DataSource&gt;</code> 缓存已初始化的数据源</li><li><code>inFlight: Map&lt;string, Promise&lt;DataSource&gt;&gt;</code> 作为“单飞锁”</li><li><code>lastUsedAt: Map&lt;string, number&gt;</code> 记录使用时间，便于回收（可选）</li></ul><blockquote><p>这里的回收策略写成“可选能力”，你也可以先不做，等租户数大了再加。</p></blockquote><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Injectable, Logger } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/common"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { DataSource, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DataSourceOptions } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "typeorm"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Injectable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TenantDataSourceManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> logger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Logger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TenantDataSourceManager.name);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> dataSources</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> inFlight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> lastUsedAt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> registry</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TenantRegistryService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tenantId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> existed</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dataSources.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (existed?.isInitialized) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.lastUsedAt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId, Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> existed;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> inflight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.inFlight.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (inflight) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> inflight;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> creating</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createAndInitDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dataSources.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId, ds);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.lastUsedAt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId, Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ds;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 初始化失败要清理 inFlight，避免后续永远卡死</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Init datasource failed for tenant=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tenantId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dataSources.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.inFlight.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.inFlight.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId, creating);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> creating;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createAndInitDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tenantId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cfg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.registry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTenantDbConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> base</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DataSourceOptions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      type: cfg.type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      host: cfg.host,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      port: cfg.port,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      username: cfg.username,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      password: cfg.password,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      database: cfg.database,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 建议：实体统一一套（所有租户结构一致）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 你可以用 autoLoadEntities + forFeature 的方式，或手动 entities 列表</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 这里写成占位：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      entities: [__dirname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "/../**/*.entity{.ts,.js}"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      synchronize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      logging: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 连接池：透传给驱动</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      extra:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        cfg.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "mysql"</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { connectionLimit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { max: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, idleTimeoutMillis: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, connectionTimeoutMillis: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2_000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(base);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ds.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">initialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ds;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 可选：回收不活跃租户 DataSource（需要你定时触发）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cleanupIdle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">maxIdleMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> now</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Date.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tenantId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">of</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dataSources.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">entries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> last</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.lastUsedAt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (now </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> last </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> maxIdleMs) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ds.isInitialized) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">continue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ds.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">destroy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Destroy datasource failed tenant=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tenantId</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}: ${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dataSources.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.lastUsedAt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><h3 id="连接数容量规划-务必算一遍" tabindex="-1">连接数容量规划（务必算一遍） <a class="header-anchor" href="#连接数容量规划-务必算一遍" aria-label="Permalink to &quot;连接数容量规划（务必算一遍）&quot;">​</a></h3><p>DB per tenant 最容易出事故的是“连接数爆炸”。</p><p>粗略公式：</p><div class="language-txt vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>总连接数 ≈ 服务实例数 × 同时活跃租户数 × 每租户 pool 上限</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>例子：</p><ul><li>5 个服务实例</li><li>同时活跃 50 个租户</li><li>每租户 <code>connectionLimit = 10</code></li></ul><p>那就是 <code>5 * 50 * 10 = 2500</code> 个连接，很容易超过 DB 端上限。</p><p>因此你通常需要：</p><ul><li>控制“活跃租户 DataSource 缓存数”（LRU/TTL 回收）</li><li>降低每租户 pool 上限（并优化 SQL）</li><li>大租户独立服务/独立集群</li></ul><hr><h2 id="step-4-request-scope-provider-把-tenant-datasource-entitymanager-注入到业务层" tabindex="-1">Step 4：REQUEST scope Provider（把 tenant DataSource / EntityManager 注入到业务层） <a class="header-anchor" href="#step-4-request-scope-provider-把-tenant-datasource-entitymanager-注入到业务层" aria-label="Permalink to &quot;Step 4：REQUEST scope Provider（把 tenant DataSource / EntityManager 注入到业务层）&quot;">​</a></h2><p>推荐注入 <strong>EntityManager</strong>，比到处 <code>getRepository()</code> 更好收口。</p><h3 id="provider-tenant-entity-manager" tabindex="-1">Provider：TENANT_ENTITY_MANAGER <a class="header-anchor" href="#provider-tenant-entity-manager" aria-label="Permalink to &quot;Provider：TENANT_ENTITY_MANAGER&quot;">​</a></h3><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Scope } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/common"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { REQUEST } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/core"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Request } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "express"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TENANT_ENTITY_MANAGER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "TENANT_ENTITY_MANAGER"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TenantEntityManagerProvider</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  provide: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TENANT_ENTITY_MANAGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  scope: Scope.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REQUEST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  inject: [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">REQUEST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, TenantDataSourceManager],</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  useFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mgr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TenantDataSourceManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tenantId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> req.tenantId;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tenantId) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">"tenantId missing on request"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mgr.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tenantId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ds.manager;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在你的 <code>TenantModule</code> 中注册：</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Module } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/common"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  providers: [TenantRegistryService, TenantDataSourceManager, TenantEntityManagerProvider],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  exports: [TenantDataSourceManager, TenantEntityManagerProvider],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TenantModule</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><hr><h2 id="step-5-业务层怎么用-像正常-typeorm-一样写" tabindex="-1">Step 5：业务层怎么用（像正常 TypeORM 一样写） <a class="header-anchor" href="#step-5-业务层怎么用-像正常-typeorm-一样写" aria-label="Permalink to &quot;Step 5：业务层怎么用（像正常 TypeORM 一样写）&quot;">​</a></h2><h3 id="示例-用-entitymanager-拿-repository" tabindex="-1">示例：用 EntityManager 拿 Repository <a class="header-anchor" href="#示例-用-entitymanager-拿-repository" aria-label="Permalink to &quot;示例：用 EntityManager 拿 Repository&quot;">​</a></h3><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { Inject, Injectable } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "@nestjs/common"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { EntityManager } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> "typeorm"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Injectable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OrdersService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(@</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Inject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TENANT_ENTITY_MANAGER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> readonly</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> em</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EntityManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> repo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.em.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(OrderEntity);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repo.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ order: { id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">"DESC"</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="事务怎么做" tabindex="-1">事务怎么做？ <a class="header-anchor" href="#事务怎么做" aria-label="Permalink to &quot;事务怎么做？&quot;">​</a></h3><p>使用 <code>this.em.transaction()</code>（事务自然发生在当前租户 DB 上）：</p><div class="language-ts vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">async </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createOrder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dto: any) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.em.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">transaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> repo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getRepository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(OrderEntity);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> entity</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repo.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dto);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repo.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(entity);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><hr><h2 id="step-6-迁移-migrations-在-db-per-tenant-的策略" tabindex="-1">Step 6：迁移（migrations）在 DB per tenant 的策略 <a class="header-anchor" href="#step-6-迁移-migrations-在-db-per-tenant-的策略" aria-label="Permalink to &quot;Step 6：迁移（migrations）在 DB per tenant 的策略&quot;">​</a></h2><p>常见策略：</p><ul><li><strong>新租户接入时跑迁移</strong>（推荐） <ul><li>创建 DB -&gt; <code>runMigrations()</code> -&gt; 标记租户 ready</li></ul></li><li><strong>发版时批处理跑迁移</strong><ul><li>遍历租户逐个跑（要做可重试、可观测、失败告警）</li></ul></li></ul><p>TypeORM v0.3+ 可以用：</p><ul><li><code>ds.runMigrations()</code></li></ul><p>但你需要考虑：</p><ul><li>并发迁移会不会锁表影响业务（一般建议串行或限流）</li><li>租户非常多时，迁移时间会很长（需要任务队列）</li></ul><hr><h2 id="常见坑与排障建议" tabindex="-1">常见坑与排障建议 <a class="header-anchor" href="#常见坑与排障建议" aria-label="Permalink to &quot;常见坑与排障建议&quot;">​</a></h2><h3 id="_1-同租户并发初始化导致连接池爆炸" tabindex="-1">1）同租户并发初始化导致连接池爆炸 <a class="header-anchor" href="#_1-同租户并发初始化导致连接池爆炸" aria-label="Permalink to &quot;1）同租户并发初始化导致连接池爆炸&quot;">​</a></h3><p>表现：</p><ul><li>连接数突然飙升</li><li>DB 报 <code>Too many connections</code></li></ul><p>解决：</p><ul><li>文章里的 <code>inFlight: Map&lt;string, Promise&lt;DataSource&gt;&gt;</code> 单飞锁是必需品</li></ul><h3 id="_2-datasource-缓存无限增长" tabindex="-1">2）DataSource 缓存无限增长 <a class="header-anchor" href="#_2-datasource-缓存无限增长" aria-label="Permalink to &quot;2）DataSource 缓存无限增长&quot;">​</a></h3><p>租户多且长尾时，Map 会越来越大。</p><p>解决：</p><ul><li>引入 LRU/TTL 回收（文中 <code>cleanupIdle</code>）</li><li>限制最大缓存数量（超出就回收最久未使用）</li></ul><h3 id="_3-实体加载方式不当" tabindex="-1">3）实体加载方式不当 <a class="header-anchor" href="#_3-实体加载方式不当" aria-label="Permalink to &quot;3）实体加载方式不当&quot;">​</a></h3><p>如果你用 <code>autoLoadEntities</code> + 动态 DataSource，可能会出现“某些实体没被加载”。</p><p>建议：</p><ul><li>在 <code>createAndInitDataSource</code> 中显式指定 <code>entities</code>（如本文示意）</li><li>或者统一导出实体数组（<code>entities: [...entities]</code>）</li></ul><h3 id="_4-tenantid-来源不可信" tabindex="-1">4）tenantId 来源不可信 <a class="header-anchor" href="#_4-tenantid-来源不可信" aria-label="Permalink to &quot;4）tenantId 来源不可信&quot;">​</a></h3><p>如果 tenantId 由客户端随便传，等于“让用户选择数据库”。</p><p>建议：</p><ul><li>tenantId 从 JWT 解析（payload 里带 tenant）</li><li>或由网关鉴权后注入 header</li></ul><hr><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>DB per tenant 在 NestJS + TypeORM 里能做，但必须把这几件事做对：</p><ul><li><strong>DataSource 缓存复用</strong>：不能每请求创建连接池</li><li><strong>并发单飞锁</strong>：避免重复 initialize</li><li><strong>连接数容量规划</strong>：实例数 × 活跃租户 × pool 上限</li><li><strong>回收策略（可选但强烈建议）</strong>：LRU/TTL 回收长尾租户 DataSource</li><li><strong>迁移策略</strong>：新租户创建时迁移 or 批处理迁移</li></ul><p>如果你补充一下你的实际环境：</p><ul><li>你用的是 <strong>MySQL 还是 Postgres</strong>？</li><li>预计租户数大概多少？同时活跃租户多少？</li><li>你现在是从 <strong>JWT</strong> 还是 <strong>网关 header</strong> 获取 tenantId？</li></ul><p>我可以把本文的“示意代码”进一步收敛成更贴近你项目的目录结构（module/service/provider），并给出更具体的 pool 参数建议。</p></div></div><div class="references s-card" data-v-ed288e97="" data-v-06f59db7=""><div class="title" data-v-06f59db7=""><i class="iconfont icon-quote" data-v-06f59db7=""></i><span class="title-text" data-v-06f59db7="">参考资料</span></div><ul class="list" data-v-06f59db7=""><!--[--><!--]--></ul></div><div class="copyright s-card" data-v-ed288e97="" data-v-891be97d=""><div class="title" data-v-891be97d=""><span class="post-name" data-v-891be97d="">NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收</span><a href="https://liuxiaodi.icu/posts/2025/nestjs-typeorm-db-per-tenant-practical" class="post-link" target="_blank" data-v-891be97d="">https://liuxiaodi.icu/posts/2025/nestjs-typeorm-db-per-tenant-practical</a></div><div class="post-meta" data-v-891be97d=""><div class="meta-item" data-v-891be97d=""><span class="tip" data-v-891be97d="">作者</span><span class="name" data-v-891be97d="">刘晓迪</span></div><div class="meta-item" data-v-891be97d=""><span class="tip" data-v-891be97d="">发布于</span><span class="name" data-v-891be97d="">4天前</span></div><div class="meta-item" data-v-891be97d=""><span class="tip" data-v-891be97d="">更新于</span><span class="name" data-v-891be97d="">今日内</span></div><div class="meta-item cc" data-v-891be97d=""><span class="tip" data-v-891be97d="">许可协议</span><a href="/redirect?url=aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpoLWhhbnM=" original-href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" class="name" target="_blank" data-v-891be97d=""> CC BY-NC-SA 4.0 </a></div></div><span class="meta-tip" data-v-891be97d="">署名-非商业性使用-相同方式共享 4.0 国际</span></div><div class="other-meta" data-v-ed288e97=""><div class="all-tags" data-v-ed288e97=""><!--[--><a href="/pages/tags/Node.js" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">Node.js</span></a><a href="/pages/tags/NestJS" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">NestJS</span></a><a href="/pages/tags/TypeORM" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">TypeORM</span></a><a href="/pages/tags/MySQL" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">MySQL</span></a><a href="/pages/tags/PostgreSQL" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">PostgreSQL</span></a><a href="/pages/tags/多租户" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">多租户</span></a><a href="/pages/tags/连接池" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">连接池</span></a><a href="/pages/tags/架构" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">架构</span></a><a href="/pages/tags/实战" class="tag-item" data-v-ed288e97=""><i class="iconfont icon-hashtag" data-v-ed288e97=""></i><span class="name" data-v-ed288e97="">实战</span></a><!--]--></div><a href="https://eqnxweimkr5.feishu.cn/share/base/form/shrcnCXCPmxCKKJYI3RKUfefJre" class="report" target="_blank" data-v-ed288e97=""><i class="iconfont icon-report" data-v-ed288e97=""></i> 反馈与投诉 </a></div><div class="reward" data-v-ed288e97="" data-v-4ca39966=""><div class="reward-btn" data-v-4ca39966=""><i class="iconfont icon-reward" data-v-4ca39966=""></i><span class="text" data-v-4ca39966="">赞赏博主</span></div><!--teleport start--><!--teleport end--></div><!----><!----><div id="main-comment" class="comment" data-v-ed288e97="" data-v-44e1332c=""><div class="title" data-v-44e1332c=""><span class="name" data-v-44e1332c=""><i class="iconfont icon-chat" data-v-44e1332c=""></i> 评论 </span><span class="tool" data-v-44e1332c=""> 隐私政策 </span></div><div id="comment-dom" class="comment-content giscus" data-v-44e1332c=""></div></div></article><aside class="main-aside" data-v-ed288e97="" data-v-c665103c=""><div class="hello s-card weidgets" data-v-c665103c="" data-v-23a11f14=""><span class="tip" data-v-23a11f14="">凌晨好，昨晚睡得怎么样？</span><div class="content" data-v-23a11f14=""><div class="site-logo" data-v-23a11f14=""><div class="clock" data-v-23a11f14="" data-v-9797ce5c=""><div class="clock-content" data-v-9797ce5c=""><div style="transform: rotate(315deg);" class="pointer hour" data-v-9797ce5c=""></div><div style="transform: rotate(45deg);" class="pointer minute" data-v-9797ce5c=""></div><div style="transform: rotate(180deg);" class="pointer second" data-v-9797ce5c=""></div></div></div></div><span class="site-desc" data-v-23a11f14="">这里记录我在“大神之路”上的学习、踩坑与成长。主要分享我的编程学习笔记、实战经验和一些有趣的想法。希望这些内容也能帮到正在路上的你。</span></div><div class="info" data-v-23a11f14=""><div class="name" data-v-23a11f14=""><span class="author" data-v-23a11f14="">刘晓迪</span><span class="desc" data-v-23a11f14="">记录大神之路上的学习、踩坑与成长</span></div><div class="link" data-v-23a11f14=""><a href="https://github.com/xiaodi-debug" target="_blank" class="social-link" data-v-23a11f14=""><i class="iconfont icon-github" data-v-23a11f14=""></i></a><a href="mailto:liuxiaodi2026@163.com" target="_blank" class="social-link" data-v-23a11f14=""><i class="iconfont icon-email" data-v-23a11f14=""></i></a></div></div></div><div class="sticky" data-v-c665103c=""><!----><div class="count-down s-card weidgets" data-v-c665103c="" data-v-48d416b4=""><div class="count-left" data-v-48d416b4=""><span class="text" data-v-48d416b4=""> 距离 </span><span class="name" data-v-48d416b4="">春节</span><span class="time" data-v-48d416b4="">57</span><span class="date" data-v-48d416b4="">2026-02-17</span></div><!----></div><div class="tags-cloud s-card weidgets" data-v-c665103c="" data-v-bb8f0e37=""><div class="title" data-v-bb8f0e37=""><i class="iconfont icon-hashtag" data-v-bb8f0e37=""></i><span class="title-name" data-v-bb8f0e37="">热门标签</span></div><div class="all-tags" data-v-bb8f0e37=""><!--[--><a href="/pages/tags/Node.js" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">Node.js</span><sup class="num" data-v-bb8f0e37="">4</sup></a><a href="/pages/tags/NestJS" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">NestJS</span><sup class="num" data-v-bb8f0e37="">5</sup></a><a href="/pages/tags/TypeORM" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">TypeORM</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/MySQL" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">MySQL</span><sup class="num" data-v-bb8f0e37="">4</sup></a><a href="/pages/tags/PostgreSQL" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">PostgreSQL</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/连接池" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">连接池</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/多租户" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">多租户</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/架构" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">架构</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/实战" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">实战</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/Redis" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">Redis</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/缓存" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">缓存</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/性能优化" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">性能优化</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/学习笔记" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">学习笔记</span><sup class="num" data-v-bb8f0e37="">4</sup></a><a href="/pages/tags/Docker" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">Docker</span><sup class="num" data-v-bb8f0e37="">3</sup></a><a href="/pages/tags/Docker Compose" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">Docker Compose</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/Nginx" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">Nginx</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/部署" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">部署</span><sup class="num" data-v-bb8f0e37="">2</sup></a><a href="/pages/tags/DevOps" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">DevOps</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/NAS" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">NAS</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/自建服务" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">自建服务</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/踩坑记录" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">踩坑记录</span><sup class="num" data-v-bb8f0e37="">4</sup></a><a href="/pages/tags/数据库设计" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">数据库设计</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/REST API" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">REST API</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/Vue3" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">Vue3</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/组合式API" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">组合式API</span><sup class="num" data-v-bb8f0e37="">1</sup></a><a href="/pages/tags/实战笔记" class="tags" data-v-bb8f0e37=""><span class="name" data-v-bb8f0e37="">实战笔记</span><sup class="num" data-v-bb8f0e37="">1</sup></a><!--]--></div><a href="/pages/tags" class="more-tags" data-v-bb8f0e37="">查看全部</a></div><div class="site-data s-card weidgets" data-v-c665103c="" data-v-ec0e2e81=""><div class="title" data-v-ec0e2e81=""><i class="iconfont icon-chart" data-v-ec0e2e81=""></i><span class="title-name" data-v-ec0e2e81="">站点数据</span></div><div class="all-data" data-v-ec0e2e81=""><div class="data-item" data-v-ec0e2e81=""><span class="name" data-v-ec0e2e81=""><i class="iconfont icon-article" data-v-ec0e2e81=""></i> 文章总数 </span><span class="num" data-v-ec0e2e81="">9 篇</span></div><div class="data-item" data-v-ec0e2e81=""><span class="name" data-v-ec0e2e81=""><i class="iconfont icon-date" data-v-ec0e2e81=""></i> 建站天数 </span><span class="num" data-v-ec0e2e81="">356 天</span></div><div class="data-item" data-v-ec0e2e81=""><span class="name" data-v-ec0e2e81=""><i class="iconfont icon-visibility" data-v-ec0e2e81=""></i> 总访问量 </span><span class="num" id="busuanzi_value_site_pv" data-v-ec0e2e81="">0</span></div><div class="data-item" data-v-ec0e2e81=""><span class="name" data-v-ec0e2e81=""><i class="iconfont icon-account" data-v-ec0e2e81=""></i> 总访客数 </span><span class="num" id="busuanzi_value_site_uv" data-v-ec0e2e81="">0</span></div></div></div></div></aside></div></div><!--]--></main><div class="footer-link" style="display:none;" data-v-bb73145d="" data-v-c44e5832=""><div class="footer-bar" data-v-c44e5832=""><span class="site-title" data-v-c44e5832="">大神之路</span><span class="site-desc" data-v-c44e5832="">记录大神之路上的学习、踩坑与成长</span><a href="/" class="to-home" data-v-c44e5832="">了解更多</a></div><div class="footer-social" data-v-c44e5832=""><!--[--><a href="mailto:liuxiaodi2026@163.com" target="_blank" class="social-link" data-v-c44e5832=""><i class="iconfont icon-email" data-v-c44e5832=""></i></a><a href="https://github.com/xiaodi-debug" target="_blank" class="social-link" data-v-c44e5832=""><i class="iconfont icon-github" data-v-c44e5832=""></i></a><a href="https://t.me/liuxiaodi" target="_blank" class="social-link" data-v-c44e5832=""><i class="iconfont icon-telegram" data-v-c44e5832=""></i></a><!--]--><div class="logo" title="返回顶部" data-v-c44e5832=""><img src="/images/logo/logo.svg" alt="author" class="author" data-v-c44e5832=""></div><!--[--><a href="https://space.bilibili.com/liuxiaodi" target="_blank" class="social-link" data-v-c44e5832=""><i class="iconfont icon-bilibili" data-v-c44e5832=""></i></a><a href="https://res.abeim.cn/api/qq/?qq=195815052" target="_blank" class="social-link" data-v-c44e5832=""><i class="iconfont icon-qq" data-v-c44e5832=""></i></a><a href="https://twitter.com/liuxiaodi" target="_blank" class="social-link" data-v-c44e5832=""><i class="iconfont icon-twitter-x" data-v-c44e5832=""></i></a><!--]--></div><div class="footer-sitemap" data-v-c44e5832=""><!--[--><div class="sitemap-item" data-v-c44e5832=""><span class="title" data-v-c44e5832="">博客</span><div class="links" data-v-c44e5832=""><!--[--><a href="/" class="link-text" data-v-c44e5832="">近期文章</a><a href="/pages/categories" class="link-text" data-v-c44e5832="">全部分类</a><a href="/pages/tags" class="link-text" data-v-c44e5832="">全部标签</a><a href="/pages/archives" class="link-text" data-v-c44e5832="">文章归档</a><!--]--></div></div><div class="sitemap-item" data-v-c44e5832=""><span class="title" data-v-c44e5832="">专栏</span><div class="links" data-v-c44e5832=""><!--[--><a href="/pages/categories/技术分享" class="link-text" data-v-c44e5832="">技术分享</a><a href="/pages/project" class="link-text" data-v-c44e5832="">我的项目</a><a href="/pages/tools" class="link-text" data-v-c44e5832="">效率工具</a><!--]--></div></div><div class="sitemap-item" data-v-c44e5832=""><span class="title" data-v-c44e5832="">页面</span><div class="links" data-v-c44e5832=""><!--[--><a href="/pages/message" class="link-text" data-v-c44e5832="">畅所欲言</a><a href="/pages/about" class="link-text" data-v-c44e5832="">关于本站</a><a href="/pages/privacy" class="link-text" data-v-c44e5832="">隐私政策</a><a href="/pages/cc" class="link-text" data-v-c44e5832="">版权协议</a><!--]--></div></div><!--]--></div></div><footer id="main-footer" class="main-footer" style="display:none;" data-v-bb73145d="" data-v-fa9bcdb7=""><div class="footer-content" data-v-fa9bcdb7=""><div class="copyright" data-v-fa9bcdb7=""><span class="time" data-v-fa9bcdb7="">@ 2019 - 2025 By </span><a href="https://github.com/xiaodi-debug" class="author link" target="_blank" data-v-fa9bcdb7="">刘晓迪</a><a class="icp link" href="https://beian.miit.gov.cn/" target="_blank" data-v-fa9bcdb7=""><i class="iconfont icon-safe" data-v-fa9bcdb7=""></i> </a><a class="upyun link" href="https://www.upyun.com" target="_blank" data-v-fa9bcdb7=""><i class="iconfont icon-upyun" data-v-fa9bcdb7=""></i> 又拍云 </a></div><div class="meta" data-v-fa9bcdb7=""><a class="power link" href="https://vitepress.dev/" target="_blank" data-v-fa9bcdb7=""><span class="by" data-v-fa9bcdb7="">Powered by</span><span class="name" data-v-fa9bcdb7="">VitePress</span></a><a href="/redirect?url=aHR0cHM6Ly9naXRodWIuY29tL2ltc3l5L3ZpdGVwcmVzcy10aGVtZS1jdXJ2ZQ==" original-href="https://github.com/imsyy/vitepress-theme-curve" class="theme link" target="_blank" data-v-fa9bcdb7="">主题</a><a class="rss link" href="https://liuxiaodi.icu/rss.xml" target="_blank" data-v-fa9bcdb7=""><i class="iconfont icon-rss" data-v-fa9bcdb7=""></i><span class="name" data-v-fa9bcdb7="">订阅</span></a><a class="cc link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" target="_blank" data-v-fa9bcdb7=""><i class="iconfont icon-line" data-v-fa9bcdb7=""></i><i class="iconfont icon-by-line" data-v-fa9bcdb7=""></i><i class="iconfont icon-nc-line" data-v-fa9bcdb7=""></i><i class="iconfont icon-nd-line" data-v-fa9bcdb7=""></i></a></div></div></footer><!--teleport start--><!--teleport end--><!--teleport start--><!--teleport end--><!--teleport start--><!--teleport end--><!--]--></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"index.md\":\"C0GCGo1H\",\"page.md\":\"Bhl6FuIV\",\"page_1.md\":\"Be0wC4dZ\",\"page_2.md\":\"CCLzlhat\",\"page_index.md\":\"R0tUBvxj\",\"pages_about.md\":\"BjzT4PBz\",\"pages_archives.md\":\"B6RLiUPp\",\"pages_categories.md\":\"F7nk0hl1\",\"pages_categories_nas.md\":\"C0vaG-ms\",\"pages_categories_前端.md\":\"BOAaY5SL\",\"pages_categories_后端.md\":\"Dc10LFaM\",\"pages_categories_数据库.md\":\"D5AvXPwE\",\"pages_categories_运维.md\":\"q-G_qp4z\",\"pages_cc.md\":\"DqIVweee\",\"pages_friends.md\":\"C_pF5LtA\",\"pages_index.md\":\"c3vYwYqq\",\"pages_link.md\":\"BpBJKJly\",\"pages_message.md\":\"BBKs1oRd\",\"pages_privacy.md\":\"DMp0d-n3\",\"pages_project.md\":\"BDJXX3XP\",\"pages_tags.md\":\"C5jRQLzu\",\"pages_tags_devops.md\":\"DKoLic_T\",\"pages_tags_docker compose.md\":\"DSjQO3Ej\",\"pages_tags_docker.md\":\"E3FGmrQr\",\"pages_tags_mysql.md\":\"D5jpGaj3\",\"pages_tags_nas.md\":\"6Q31FrAh\",\"pages_tags_nestjs.md\":\"BDNcKzXx\",\"pages_tags_nginx.md\":\"B7PlsTrG\",\"pages_tags_node.js.md\":\"C63WZnmI\",\"pages_tags_postgresql.md\":\"BkqEg9GP\",\"pages_tags_redis.md\":\"DDugPLuo\",\"pages_tags_rest api.md\":\"CQav327i\",\"pages_tags_typeorm.md\":\"CEZk5Vdk\",\"pages_tags_vue3.md\":\"DAqrK9Tx\",\"pages_tags_多租户.md\":\"DM6vVSFY\",\"pages_tags_学习笔记.md\":\"5Gj2AKEi\",\"pages_tags_实战.md\":\"D4-SENC-\",\"pages_tags_实战笔记.md\":\"YBb85aV5\",\"pages_tags_性能优化.md\":\"BdDMKXnX\",\"pages_tags_数据库设计.md\":\"C86z9y4O\",\"pages_tags_架构.md\":\"AkRwaJbF\",\"pages_tags_组合式api.md\":\"BR0d2H3-\",\"pages_tags_缓存.md\":\"BjmRtFFo\",\"pages_tags_自建服务.md\":\"79LdnUvx\",\"pages_tags_踩坑记录.md\":\"h8kCB0BF\",\"pages_tags_连接池.md\":\"Cqe9rKvI\",\"pages_tags_部署.md\":\"DKcjK8ib\",\"pages_thanks.md\":\"BS8o1dXr\",\"posts_2025_1010.md\":\"CJ5cQzCn\",\"posts_2025_docker-compose-tutorial.md\":\"P7tuDrSV\",\"posts_2025_mysql-notes-basics.md\":\"B055KQV2\",\"posts_2025_nas-docker-feiniu-deploy.md\":\"DsXhAXuT\",\"posts_2025_nestjs-docker-compose-stack.md\":\"SiXnj-lb\",\"posts_2025_nestjs-first-api.md\":\"uJihhmMm\",\"posts_2025_nestjs-redis-cache.md\":\"CgwwJblV\",\"posts_2025_nestjs-typeorm-db-per-tenant-practical.md\":\"DeZoFMpW\",\"posts_2025_nestjs-typeorm-multitenancy-pool.md\":\"CoFgyVuu\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"大神之路\",\"description\":\"记录大神之路上的学习、踩坑与成长\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":\"dark\",\"themeConfig\":{\"siteMeta\":{\"title\":\"大神之路\",\"description\":\"记录大神之路上的学习、踩坑与成长\",\"logo\":\"/images/logo/logo.svg\",\"site\":\"https://liuxiaodi.icu\",\"lang\":\"zh-CN\",\"author\":{\"name\":\"刘晓迪\",\"cover\":\"/images/logo/logo.svg\",\"email\":\"114514@gmail.com\",\"link\":\"https://github.com/xiaodi-debug\"}},\"icp\":\"\",\"since\":\"2025-01-01\",\"postSize\":8,\"inject\":{\"header\":[[\"link\",{\"rel\":\"icon\",\"href\":\"/images/logo/logo.svg\"}],[\"meta\",{\"name\":\"referrer\",\"content\":\"no-referrer\"}],[\"link\",{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"title\":\"RSS\",\"href\":\"https://liuxiaodi.icu/rss.xml\"}],[\"link\",{\"crossorigin\":\"\",\"rel\":\"preconnect\",\"href\":\"https://s1.hdslb.com\"}],[\"link\",{\"crossorigin\":\"\",\"rel\":\"preconnect\",\"href\":\"https://mirrors.sustech.edu.cn\"}],[\"link\",{\"crossorigin\":\"anonymous\",\"rel\":\"stylesheet\",\"href\":\"https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css\"}],[\"link\",{\"crossorigin\":\"anonymous\",\"rel\":\"stylesheet\",\"href\":\"https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.css\"}],[\"link\",{\"crossorigin\":\"anonymous\",\"rel\":\"stylesheet\",\"href\":\"https://cdn2.codesign.qq.com/icons/g5ZpEgx3z4VO6j2/latest/iconfont.css\"}],[\"link\",{\"rel\":\"preconnect\",\"href\":\"https://use.sevencdn.com\"}],[\"link\",{\"rel\":\"preconnect\",\"href\":\"https://fonts.gstatic.com\",\"crossorigin\":\"\"}],[\"link\",{\"crossorigin\":\"anonymous\",\"href\":\"https://use.sevencdn.com/css2?family=Fira+Code:wght@300..700&display=swap\",\"rel\":\"stylesheet\"}],[\"link\",{\"href\":\"https://X5EBEZB53I-dsn.algolia.net\",\"rel\":\"preconnect\",\"crossorigin\":\"\"}],[\"script\",{\"src\":\"https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js\",\"defer\":\"\"}],[\"script\",{\"id\":\"check-dark-mode\"},\";(() => {\\n               const preference = localStorage.getItem('vitepress-theme-appearance') || 'dark'\\n               const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches\\n               if (!preference || preference === 'auto' ? prefersDark : preference === 'dark')\\n                 document.documentElement.classList.add('dark')\\n             })()\"],[\"script\",{\"id\":\"check-mac-os\"},\"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))\"]]},\"nav\":[{\"text\":\"文库\",\"items\":[{\"text\":\"文章列表\",\"link\":\"/pages/archives\",\"icon\":\"article\"},{\"text\":\"全部分类\",\"link\":\"/pages/categories\",\"icon\":\"folder\"},{\"text\":\"全部标签\",\"link\":\"/pages/tags\",\"icon\":\"hashtag\"}]},{\"text\":\"专栏\",\"items\":[{\"text\":\"技术分享\",\"link\":\"/pages/categories/技术分享\",\"icon\":\"technical\"},{\"text\":\"我的项目\",\"link\":\"/pages/project\",\"icon\":\"code\"},{\"text\":\"效率工具\",\"link\":\"/pages/tools\",\"icon\":\"tools\"}]},{\"text\":\"友链\",\"items\":[{\"text\":\"友链鱼塘\",\"link\":\"/pages/friends\",\"icon\":\"fish\"},{\"text\":\"友情链接\",\"link\":\"/pages/link\",\"icon\":\"people\"}]},{\"text\":\"我的\",\"items\":[{\"text\":\"畅所欲言\",\"link\":\"/pages/message\",\"icon\":\"chat\"},{\"text\":\"致谢名单\",\"link\":\"/pages/thanks\",\"icon\":\"reward\"},{\"text\":\"关于本站\",\"link\":\"/pages/about\",\"icon\":\"contacts\"}]}],\"navMore\":[{\"name\":\"博客\",\"list\":[{\"icon\":\"/images/logo/logo.webp\",\"name\":\"大神之路\",\"url\":\"/\"},{\"icon\":\"/images/logo/logo.webp\",\"name\":\"GitHub\",\"url\":\"https://github.com/xiaodi-debug\"}]}],\"cover\":{\"twoColumns\":false,\"showCover\":{\"enable\":true,\"coverLayout\":\"both\"}},\"footer\":{\"social\":[{\"icon\":\"email\",\"link\":\"mailto:liuxiaodi2026@163.com\"},{\"icon\":\"github\",\"link\":\"https://github.com/xiaodi-debug\"},{\"icon\":\"telegram\",\"link\":\"https://t.me/liuxiaodi\"},{\"icon\":\"bilibili\",\"link\":\"https://space.bilibili.com/liuxiaodi\"},{\"icon\":\"qq\",\"link\":\"https://res.abeim.cn/api/qq/?qq=195815052\"},{\"icon\":\"twitter-x\",\"link\":\"https://twitter.com/liuxiaodi\"}],\"sitemap\":[{\"text\":\"博客\",\"items\":[{\"text\":\"近期文章\",\"link\":\"/\"},{\"text\":\"全部分类\",\"link\":\"/pages/categories\"},{\"text\":\"全部标签\",\"link\":\"/pages/tags\"},{\"text\":\"文章归档\",\"link\":\"/pages/archives\"}]},{\"text\":\"专栏\",\"items\":[{\"text\":\"技术分享\",\"link\":\"/pages/categories/技术分享\"},{\"text\":\"我的项目\",\"link\":\"/pages/project\"},{\"text\":\"效率工具\",\"link\":\"/pages/tools\"}]},{\"text\":\"页面\",\"items\":[{\"text\":\"畅所欲言\",\"link\":\"/pages/message\"},{\"text\":\"关于本站\",\"link\":\"/pages/about\"},{\"text\":\"隐私政策\",\"link\":\"/pages/privacy\"},{\"text\":\"版权协议\",\"link\":\"/pages/cc\"}]}]},\"comment\":{\"enable\":true,\"type\":\"giscus\",\"giscus\":{\"repo\":\"xiaodi-debug/xiaodi-debug.github.io\",\"repoId\":\"R_kgDOQpERpA\",\"category\":\"General\",\"categoryId\":\"DIC_kwDOQpERpM4C0IDj\",\"mapping\":\"pathname\",\"strict\":0,\"reactionsEnabled\":1,\"emitMetadata\":0,\"inputPosition\":\"bottom\",\"theme\":\"preferred_color_scheme\",\"lang\":\"zh-CN\"},\"artalk\":{\"site\":\"\",\"server\":\"\"},\"twikoo\":{\"js\":\"https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/twikoo/1.6.39/twikoo.all.min.js\",\"envId\":\"\",\"region\":\"ap-shanghai\",\"lang\":\"zh-CN\"}},\"aside\":{\"hello\":{\"enable\":true,\"text\":\"这里记录我在“大神之路”上的学习、踩坑与成长。主要分享我的编程学习笔记、实战经验和一些有趣的想法。希望这些内容也能帮到正在路上的你。\"},\"toc\":{\"enable\":true},\"tags\":{\"enable\":true},\"countDown\":{\"enable\":true,\"data\":{\"name\":\"春节\",\"date\":\"2026-02-17\"}},\"siteData\":{\"enable\":true}},\"friends\":{\"circleOfFriends\":\"\",\"dynamicLink\":{\"server\":\"\",\"app_token\":\"\",\"table_id\":\"\"}},\"music\":{\"enable\":false,\"url\":\"https://github.com/imsyy/Meting-API\",\"id\":9379831714,\"server\":\"netease\",\"type\":\"playlist\"},\"search\":{\"enable\":false,\"appId\":\"\",\"apiKey\":\"\"},\"rewardData\":{\"enable\":true,\"wechat\":\"https://via.placeholder.com/260x260?text=%E5%BE%AE%E4%BF%A1%E6%89%93%E8%B5%8F\",\"alipay\":\"https://via.placeholder.com/260x260?text=%E6%94%AF%E4%BB%98%E5%AE%9D%E6%89%93%E8%B5%8F\"},\"fancybox\":{\"enable\":true,\"js\":\"https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.umd.min.js\",\"css\":\"https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.min.css\"},\"jumpRedirect\":{\"enable\":true,\"exclude\":[\"cf-friends-link\",\"upyun\",\"icp\",\"author\",\"rss\",\"cc\",\"power\",\"social-link\",\"link-text\",\"travellings\",\"post-link\",\"report\",\"more-link\",\"skills-item\",\"right-menu-link\",\"link-card\"]},\"tongji\":{\"51la\":\"\"},\"postData\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"},{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":648071631,\"title\":\"在飞牛 NAS 上用 Docker 折腾 CloudSave、quark-auto-save、v2raya\",\"date\":1765324800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":13,\"tags\":[\"NAS\",\"Docker\",\"自建服务\",\"踩坑记录\"],\"categories\":[\"NAS\"],\"description\":\"记录我在飞牛 NAS 上用 Docker 部署 CloudSave、quark-auto-save、v2raya、飞牛影视和飞牛图库的过程，以及中间踩过的一些小坑。\",\"regularPath\":\"/posts/2025/nas-docker-feiniu-deploy.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":6150546409,\"title\":\"MySQL 学习笔记：从表设计到常见查询（附踩坑记录）\",\"date\":1763596800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":33,\"tags\":[\"MySQL\",\"数据库设计\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"数据库\"],\"description\":\"记录我在用 MySQL 做博客/业务系统时的一些基础表设计思路、常见查询写法，以及编码、索引、N+1 查询等踩过的坑。\",\"regularPath\":\"/posts/2025/mysql-notes-basics.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/mysql.png\"},{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":2706237109,\"title\":\"Vue3 学习笔记：一个带搜索和分页的文章列表\",\"date\":1762732800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":43,\"tags\":[\"Vue3\",\"组合式API\",\"实战笔记\",\"踩坑记录\"],\"categories\":[\"前端\"],\"description\":\"用 Vue3 组合式 API 实战一个带搜索、分页、状态缓存的文章列表页面，并记录中间踩过的坑。\",\"regularPath\":\"/posts/2025/1010.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/vue.png\"}],\"tagsData\":{\"Node.js\":{\"count\":4,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"},{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"NestJS\":{\"count\":5,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"},{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"TypeORM\":{\"count\":2,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"MySQL\":{\"count\":4,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":6150546409,\"title\":\"MySQL 学习笔记：从表设计到常见查询（附踩坑记录）\",\"date\":1763596800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":33,\"tags\":[\"MySQL\",\"数据库设计\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"数据库\"],\"description\":\"记录我在用 MySQL 做博客/业务系统时的一些基础表设计思路、常见查询写法，以及编码、索引、N+1 查询等踩过的坑。\",\"regularPath\":\"/posts/2025/mysql-notes-basics.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/mysql.png\"}]},\"PostgreSQL\":{\"count\":2,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"连接池\":{\"count\":2,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"多租户\":{\"count\":2,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"架构\":{\"count\":2,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"实战\":{\"count\":2,\"articles\":[{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"Redis\":{\"count\":2,\"articles\":[{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"},{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"缓存\":{\"count\":1,\"articles\":[{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"}]},\"性能优化\":{\"count\":1,\"articles\":[{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"}]},\"学习笔记\":{\"count\":4,\"articles\":[{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"},{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":6150546409,\"title\":\"MySQL 学习笔记：从表设计到常见查询（附踩坑记录）\",\"date\":1763596800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":33,\"tags\":[\"MySQL\",\"数据库设计\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"数据库\"],\"description\":\"记录我在用 MySQL 做博客/业务系统时的一些基础表设计思路、常见查询写法，以及编码、索引、N+1 查询等踩过的坑。\",\"regularPath\":\"/posts/2025/mysql-notes-basics.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/mysql.png\"},{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"Docker\":{\"count\":3,\"articles\":[{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":648071631,\"title\":\"在飞牛 NAS 上用 Docker 折腾 CloudSave、quark-auto-save、v2raya\",\"date\":1765324800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":13,\"tags\":[\"NAS\",\"Docker\",\"自建服务\",\"踩坑记录\"],\"categories\":[\"NAS\"],\"description\":\"记录我在飞牛 NAS 上用 Docker 部署 CloudSave、quark-auto-save、v2raya、飞牛影视和飞牛图库的过程，以及中间踩过的一些小坑。\",\"regularPath\":\"/posts/2025/nas-docker-feiniu-deploy.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"Docker Compose\":{\"count\":2,\"articles\":[{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"Nginx\":{\"count\":1,\"articles\":[{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"部署\":{\"count\":2,\"articles\":[{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"DevOps\":{\"count\":1,\"articles\":[{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"NAS\":{\"count\":1,\"articles\":[{\"id\":648071631,\"title\":\"在飞牛 NAS 上用 Docker 折腾 CloudSave、quark-auto-save、v2raya\",\"date\":1765324800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":13,\"tags\":[\"NAS\",\"Docker\",\"自建服务\",\"踩坑记录\"],\"categories\":[\"NAS\"],\"description\":\"记录我在飞牛 NAS 上用 Docker 部署 CloudSave、quark-auto-save、v2raya、飞牛影视和飞牛图库的过程，以及中间踩过的一些小坑。\",\"regularPath\":\"/posts/2025/nas-docker-feiniu-deploy.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"自建服务\":{\"count\":1,\"articles\":[{\"id\":648071631,\"title\":\"在飞牛 NAS 上用 Docker 折腾 CloudSave、quark-auto-save、v2raya\",\"date\":1765324800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":13,\"tags\":[\"NAS\",\"Docker\",\"自建服务\",\"踩坑记录\"],\"categories\":[\"NAS\"],\"description\":\"记录我在飞牛 NAS 上用 Docker 部署 CloudSave、quark-auto-save、v2raya、飞牛影视和飞牛图库的过程，以及中间踩过的一些小坑。\",\"regularPath\":\"/posts/2025/nas-docker-feiniu-deploy.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"踩坑记录\":{\"count\":4,\"articles\":[{\"id\":648071631,\"title\":\"在飞牛 NAS 上用 Docker 折腾 CloudSave、quark-auto-save、v2raya\",\"date\":1765324800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":13,\"tags\":[\"NAS\",\"Docker\",\"自建服务\",\"踩坑记录\"],\"categories\":[\"NAS\"],\"description\":\"记录我在飞牛 NAS 上用 Docker 部署 CloudSave、quark-auto-save、v2raya、飞牛影视和飞牛图库的过程，以及中间踩过的一些小坑。\",\"regularPath\":\"/posts/2025/nas-docker-feiniu-deploy.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":6150546409,\"title\":\"MySQL 学习笔记：从表设计到常见查询（附踩坑记录）\",\"date\":1763596800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":33,\"tags\":[\"MySQL\",\"数据库设计\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"数据库\"],\"description\":\"记录我在用 MySQL 做博客/业务系统时的一些基础表设计思路、常见查询写法，以及编码、索引、N+1 查询等踩过的坑。\",\"regularPath\":\"/posts/2025/mysql-notes-basics.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/mysql.png\"},{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":2706237109,\"title\":\"Vue3 学习笔记：一个带搜索和分页的文章列表\",\"date\":1762732800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":43,\"tags\":[\"Vue3\",\"组合式API\",\"实战笔记\",\"踩坑记录\"],\"categories\":[\"前端\"],\"description\":\"用 Vue3 组合式 API 实战一个带搜索、分页、状态缓存的文章列表页面，并记录中间踩过的坑。\",\"regularPath\":\"/posts/2025/1010.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/vue.png\"}]},\"数据库设计\":{\"count\":1,\"articles\":[{\"id\":6150546409,\"title\":\"MySQL 学习笔记：从表设计到常见查询（附踩坑记录）\",\"date\":1763596800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":33,\"tags\":[\"MySQL\",\"数据库设计\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"数据库\"],\"description\":\"记录我在用 MySQL 做博客/业务系统时的一些基础表设计思路、常见查询写法，以及编码、索引、N+1 查询等踩过的坑。\",\"regularPath\":\"/posts/2025/mysql-notes-basics.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/mysql.png\"}]},\"REST API\":{\"count\":1,\"articles\":[{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"Vue3\":{\"count\":1,\"articles\":[{\"id\":2706237109,\"title\":\"Vue3 学习笔记：一个带搜索和分页的文章列表\",\"date\":1762732800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":43,\"tags\":[\"Vue3\",\"组合式API\",\"实战笔记\",\"踩坑记录\"],\"categories\":[\"前端\"],\"description\":\"用 Vue3 组合式 API 实战一个带搜索、分页、状态缓存的文章列表页面，并记录中间踩过的坑。\",\"regularPath\":\"/posts/2025/1010.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/vue.png\"}]},\"组合式API\":{\"count\":1,\"articles\":[{\"id\":2706237109,\"title\":\"Vue3 学习笔记：一个带搜索和分页的文章列表\",\"date\":1762732800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":43,\"tags\":[\"Vue3\",\"组合式API\",\"实战笔记\",\"踩坑记录\"],\"categories\":[\"前端\"],\"description\":\"用 Vue3 组合式 API 实战一个带搜索、分页、状态缓存的文章列表页面，并记录中间踩过的坑。\",\"regularPath\":\"/posts/2025/1010.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/vue.png\"}]},\"实战笔记\":{\"count\":1,\"articles\":[{\"id\":2706237109,\"title\":\"Vue3 学习笔记：一个带搜索和分页的文章列表\",\"date\":1762732800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":43,\"tags\":[\"Vue3\",\"组合式API\",\"实战笔记\",\"踩坑记录\"],\"categories\":[\"前端\"],\"description\":\"用 Vue3 组合式 API 实战一个带搜索、分页、状态缓存的文章列表页面，并记录中间踩过的坑。\",\"regularPath\":\"/posts/2025/1010.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/vue.png\"}]}},\"categoriesData\":{\"后端\":{\"count\":4,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"},{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"}]},\"运维\":{\"count\":2,\"articles\":[{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"NAS\":{\"count\":1,\"articles\":[{\"id\":648071631,\"title\":\"在飞牛 NAS 上用 Docker 折腾 CloudSave、quark-auto-save、v2raya\",\"date\":1765324800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":13,\"tags\":[\"NAS\",\"Docker\",\"自建服务\",\"踩坑记录\"],\"categories\":[\"NAS\"],\"description\":\"记录我在飞牛 NAS 上用 Docker 部署 CloudSave、quark-auto-save、v2raya、飞牛影视和飞牛图库的过程，以及中间踩过的一些小坑。\",\"regularPath\":\"/posts/2025/nas-docker-feiniu-deploy.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"}]},\"数据库\":{\"count\":1,\"articles\":[{\"id\":6150546409,\"title\":\"MySQL 学习笔记：从表设计到常见查询（附踩坑记录）\",\"date\":1763596800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":33,\"tags\":[\"MySQL\",\"数据库设计\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"数据库\"],\"description\":\"记录我在用 MySQL 做博客/业务系统时的一些基础表设计思路、常见查询写法，以及编码、索引、N+1 查询等踩过的坑。\",\"regularPath\":\"/posts/2025/mysql-notes-basics.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/mysql.png\"}]},\"前端\":{\"count\":1,\"articles\":[{\"id\":2706237109,\"title\":\"Vue3 学习笔记：一个带搜索和分页的文章列表\",\"date\":1762732800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":43,\"tags\":[\"Vue3\",\"组合式API\",\"实战笔记\",\"踩坑记录\"],\"categories\":[\"前端\"],\"description\":\"用 Vue3 组合式 API 实战一个带搜索、分页、状态缓存的文章列表页面，并记录中间踩过的坑。\",\"regularPath\":\"/posts/2025/1010.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/vue.png\"}]}},\"archivesData\":{\"data\":{\"2025\":{\"count\":9,\"articles\":[{\"id\":774093338,\"title\":\"NestJS + TypeORM：连接池配置与多租户实践（可落地方案）\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"连接池\",\"多租户\",\"架构\"],\"categories\":[\"后端\"],\"description\":\"介绍在 NestJS 中使用 TypeORM 时如何正确配置连接池，并给出多租户（单库多租户 / 多库多租户）两种常见实现方案：租户解析、DataSource 管理、Provider 注入、迁移策略与常见坑。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-multitenancy-pool.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/typeorm.png\"},{\"id\":849603499,\"title\":\"NestJS + TypeORM 多库多租户（DB per tenant）代码落地：DataSource 管理、并发单飞与回收\",\"date\":1766102400000,\"lastModified\":1766453722647.0676,\"updated\":1766453722647.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"TypeORM\",\"MySQL\",\"PostgreSQL\",\"多租户\",\"连接池\",\"架构\",\"实战\"],\"categories\":[\"后端\"],\"description\":\"多库多租户（每个租户一个数据库）在 NestJS + TypeORM v0.3+ 下的可落地实现：tenant 解析、TenantDataSourceManager（并发单飞锁）、REQUEST scope provider 注入、Repository/EntityManager 使用方式、连接池容量规划与回收策略。\",\"regularPath\":\"/posts/2025/nestjs-typeorm-db-per-tenant-practical.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":162754159,\"title\":\"NestJS 使用 Redis 缓存：从接入到失效策略与最佳实践\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Node.js\",\"NestJS\",\"Redis\",\"缓存\",\"性能优化\",\"学习笔记\"],\"categories\":[\"后端\"],\"description\":\"以 NestJS 为例介绍如何接入 Redis 做缓存，包括 CacheModule 接入、接口级缓存、手动缓存、缓存失效、Key 设计以及常见坑与最佳实践。\",\"regularPath\":\"/posts/2025/nestjs-redis-cache.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/redis.png\"},{\"id\":1119265013,\"title\":\"一套可直接跑的 Docker Compose：NestJS + MySQL + Redis + Nginx（含 .env/初始化 SQL/反代）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"NestJS\",\"MySQL\",\"Redis\",\"Nginx\",\"部署\",\"实战\"],\"categories\":[\"运维\"],\"description\":\"给出一套可直接复制运行的 Docker Compose 栈：Nginx 作为入口反代到 NestJS，MySQL 持久化并支持初始化 SQL，Redis 提供缓存能力，包含目录结构、.env、nginx 配置、init.sql 与 Dockerfile。\",\"regularPath\":\"/posts/2025/nestjs-docker-compose-stack.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":1250074321,\"title\":\"Docker 安装 + 常用命令 + Docker Compose 使用教程（从0到能用）\",\"date\":1766102400000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":4,\"tags\":[\"Docker\",\"Docker Compose\",\"DevOps\",\"部署\",\"学习笔记\"],\"categories\":[\"运维\"],\"description\":\"一篇面向新手的 Docker 实战教程：从安装 Docker（Windows/Linux）开始，整理最常用的 Docker 命令，并用 Docker Compose 演示如何一键启动多服务（MySQL/Redis/Nginx/应用）。\",\"regularPath\":\"/posts/2025/docker-compose-tutorial.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":648071631,\"title\":\"在飞牛 NAS 上用 Docker 折腾 CloudSave、quark-auto-save、v2raya\",\"date\":1765324800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":13,\"tags\":[\"NAS\",\"Docker\",\"自建服务\",\"踩坑记录\"],\"categories\":[\"NAS\"],\"description\":\"记录我在飞牛 NAS 上用 Docker 部署 CloudSave、quark-auto-save、v2raya、飞牛影视和飞牛图库的过程，以及中间踩过的一些小坑。\",\"regularPath\":\"/posts/2025/nas-docker-feiniu-deploy.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/docker.png\"},{\"id\":6150546409,\"title\":\"MySQL 学习笔记：从表设计到常见查询（附踩坑记录）\",\"date\":1763596800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":33,\"tags\":[\"MySQL\",\"数据库设计\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"数据库\"],\"description\":\"记录我在用 MySQL 做博客/业务系统时的一些基础表设计思路、常见查询写法，以及编码、索引、N+1 查询等踩过的坑。\",\"regularPath\":\"/posts/2025/mysql-notes-basics.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/mysql.png\"},{\"id\":2273445122,\"title\":\"NestJS 学习笔记：从0到1实现鉴权的接口\",\"date\":1763164800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":38,\"tags\":[\"Node.js\",\"NestJS\",\"REST API\",\"学习笔记\",\"踩坑记录\"],\"categories\":[\"后端\"],\"description\":\"记录我用 NestJS 从 0 搭出一个简单 REST API 服务的过程，包括项目初始化、模块划分、JWT 登录鉴权，以及中间遇到的一些坑。\",\"regularPath\":\"/posts/2025/nestjs-first-api.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/nestjs.png\"},{\"id\":2706237109,\"title\":\"Vue3 学习笔记：一个带搜索和分页的文章列表\",\"date\":1762732800000,\"lastModified\":1766453722646.0676,\"updated\":1766453722646.0676,\"expired\":43,\"tags\":[\"Vue3\",\"组合式API\",\"实战笔记\",\"踩坑记录\"],\"categories\":[\"前端\"],\"description\":\"用 Vue3 组合式 API 实战一个带搜索、分页、状态缓存的文章列表页面，并记录中间踩过的坑。\",\"regularPath\":\"/posts/2025/1010.html\",\"cover\":\"https://gitee.com/its-liu-xiaodi_admin/my_img/raw/image/vue.png\"}]}},\"year\":[\"2025\"]}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  
</body></html>